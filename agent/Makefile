#
#   Copyright [2011] [Red Hat, Inc.]
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#  limitations under the License.
#

AUDREY_STARTUP_CACHE_DIR	?= $(HOME)/audrey-agent-cache

VERSION = 0.5.0
RELEASE = 0

# For Release: 0..., set _audrey-agent_dev=1 so that we get extra_release.GIT-
# annotated rpm version strings.
_audrey-agent_dev =  $(shell grep -q '^[[:space:]]*Release:[[:space:]]*0' \
   aeolus-audrey-agent.spec.in && echo 1 || :)

# use $(shell...) here to collect the git head and date *once* per make target.
# that ensures that if multiple actions happen in the same target (like the
# multiple RPM builds in the rpms target), they all use the same date
git_head	= $(shell git log -1 --pretty=format:%h)
date		= $(shell date --utc +%Y%m%d%H%M%S)
GIT_HASH	= $(date)git$(git_head)
RPMDIR		= $$(rpm --eval '%{_rpmdir}')
ifeq ($(RELEASE),0)
	RELEASE_SED = $(RELEASE)%{?dist}.$(GIT_HASH)
else
	RELEASE_SED = $(RELEASE)%{?dist}
endif
# RPM_FLAGS	= --define "audrey-agent_cache_dir $(AUDREY_STARTUP_CACHE_DIR)"
man_section = 8

# Create the dist.
#    Run the audrey_agent.py audrey.$(man_section) then:
#        Set the version numbers in aeolus-audrey-agent.spec and audrey_agent.py
#        Copy the desired bits to the dist directory.
#        tar up the contents of the dist directory.
dist: src/audrey/agent.py audrey.$(man_section)
	rm -rf dist
	mkdir -p dist/aeolus-audrey-agent-$(VERSION)
	sed -e 's/@VERSION@/$(VERSION)/' -e 's/@RELEASE@/$(RELEASE_SED)/' \
		aeolus-audrey-agent.spec.in > aeolus-audrey-agent.spec
	cp -ar aeolus-audrey-agent.spec.in aeolus-audrey-agent.spec \
		COPYING Makefile src bin audrey.$(man_section) \
		test_audrey_agent.py scripts dist/aeolus-audrey-agent-$(VERSION)
	tar -C dist -zcvf aeolus-audrey-agent-$(VERSION).tar.gz aeolus-audrey-agent-$(VERSION)

# cp src/audrey/agent.py.in to src/audrey/agent.py
src/audrey/agent.py: src/audrey/agent.py.in
	sed -e 's/@VERSION@/$(VERSION)/' $< > $@

# Generate the man page using help2man from the --help text output
# from the Audrey agent.
#    Run the audrey target before generating the man page.
audrey.$(man_section): bin/audrey
	PYTHONPATH=$(PYTHONPATH):src ./$< --help > /dev/null
	PYTHONPATH=$(PYTHONPATH):src help2man --name='Aeolus agent' \
        --section $(man_section) --no-info ./$< > $@

# Run the automated tests
#    Run the audrey_agent.py target before running the automated tests
test: src/audrey/agent.py
	python test_audrey_agent.py

# Build the rpms
#    Run the test target followed by the dist target before building the rpms.
rpms: test dist
	rpmbuild $(RPM_FLAGS) -ta aeolus-audrey-agent-$(VERSION).tar.gz

# Build the srpms
srpm: test dist
	rpmbuild $(RPM_FLAGS) -bs aeolus-audrey-agent.spec

# Clean up files generated by this Makefile
clean:
	rm -rf dist aeolus-audrey-agent-$(VERSION).tar.gz \
	aeolus-audrey-agent.spec audrey.$(man_section) \
	audrey.log src/audrey/agent.py src/audrey/agent.pyc \
	test_toolinglog test_toolinguser \
	toolinglog toolinguser

# report coverage
coverage: src/audrey/agent.py
	coverage erase
	coverage run test_audrey_agent.py
	coverage report -m test_audrey_agent.py src/audrey/*.py tests/*.py

.PHONY: dist test rpms srpm
