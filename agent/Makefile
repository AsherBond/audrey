#
#   Copyright [2011] [Red Hat, Inc.]
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#  limitations under the License.
#

AUDREY_STARTUP_CACHE_DIR	?= $(HOME)/audrey-agent-cache

VERSION = 0.4.10

# For Release: 0..., set _audrey-agent_dev=1 so that we get extra_release.GIT-
# annotated rpm version strings.
_audrey-agent_dev =  $(shell grep -q '^[[:space:]]*Release:[[:space:]]*0' \
   aeolus-audrey-agent.spec.in && echo 1 || :)

# use $(shell...) here to collect the git head and date *once* per make target.
# that ensures that if multiple actions happen in the same target (like the
# multiple RPM builds in the rpms target), they all use the same date
git_head	= $(shell git log -1 --pretty=format:%h)
date		= $(shell date --utc +%Y%m%d%H%M%S)
GIT_RELEASE	= $(date)git$(git_head)
RPMDIR		= $$(rpm --eval '%{_rpmdir}')
RELEASE		= $(shell grep ^Release: aeolus-audrey-agent.spec.in | \
			sed -e 's/Release:[ ,	]*//' | sed -e 's/%.*//')
# RPM_FLAGS	= --define "audrey-agent_cache_dir $(AUDREY_STARTUP_CACHE_DIR)"
# RPM_FLAGS	+= $(if $(_audrey-agent_dev),--define "extra_release .$(GIT_RELEASE)")
man_section = 8

# Create the dist.
#    Run the audrey_agent.py audrey.$(man_section) then:
#        Set the version numbers in aeolus-audrey-agent.spec and audrey_agent.py
#        Copy the desired bits to the dist directory.
#        tar up the contents of the dist directory.
dist: audrey_agent.py audrey.$(man_section)
	rm -rf dist
	sed -e 's/@VERSION@/$(VERSION)/' aeolus-audrey-agent.spec.in \
	  > aeolus-audrey-agent.spec
	mkdir -p dist/aeolus-audrey-agent-$(VERSION)
	cp -a aeolus-audrey-agent.spec aeolus-audrey-agent.spec.in \
		COPYING Makefile audrey_agent.in.py \
		audrey.$(man_section) scripts \
		test_audrey_agent.py dist/aeolus-audrey-agent-$(VERSION)
	tar -C dist -zcvf aeolus-audrey-agent-$(VERSION).tar.gz aeolus-audrey-agent-$(VERSION)

# cp audrey_agent.in.py to audrey_agent.py
audrey_agent.py: audrey_agent.in.py
	sed -e 's/@VERSION@/$(VERSION)/' $< > $@-t
	chmod a+x,a-w $@-t
	mv $@-t $@

# cp audrey_starup.py to audrey.
audrey: audrey_agent.py
	cp $< $@

# Generate the man page using help2man from the --help text output
# from the Audrey agent.
#    Run the audrey target before generating the man page.
audrey.$(man_section): audrey
	./$< --help
	help2man --name='Aeolus agent' --section $(man_section) \
	    --no-info ./$< > $@-t
	mv $@-t $@

# Run the automated tests
#    Run the audrey_agent.py target before running the automated tests.
check: audrey_agent.py
	python test_audrey_agent.py

# Build the rpms
#    Run the check target followed by the dist target before building the rpms.
rpms: check dist
	rpmbuild -ta aeolus-audrey-agent-$(VERSION).tar.gz

# Build the srpms
srpm: check dist
	rpmbuild -ts aeolus-audrey-agent-$(VERSION).tar.gz

# Clean up files generated by this Makefile
clean:
	rm -rf dist aeolus-audrey-agent-$(VERSION).tar.gz \
	aeolus-audrey-agent.spec audrey.$(man_section) audrey \
	audrey.log audrey_agent.py audrey_agent.pyc \
	test_toolinglog test_toolinguser \
	toolinglog toolinguser

# run tests
test: audrey_agent.py
	coverage run test_audrey_agent.py

# report coverage
coverage: test
	coverage report -m audrey_agent.py

.PHONY: dist check rpms srpm
